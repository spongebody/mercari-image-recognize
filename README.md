# Mercari Image Analyzer

## Quick start

1) Install dependencies:
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2) Configure `.env` (loaded automatically by `python-dotenv` in `app/config.py`).

3) Run the API:
```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```

## Price strategy behavior

Default is `vision` when `price_strategy` is missing or invalid.

- `vision` (default): price is generated by the vision model in one pass.
  - Prompts: `VISION_SYSTEM_PROMPT_WITH_PRICE` + `VISION_USER_PROMPT_WITH_PRICE`
  - Model: `VISION_MODEL`
  - Behavior: image-only, no web search; returns inline prices.
- `vision_online`: price is generated by the vision model with search instructions.
  - Prompts: `VISION_SYSTEM_PROMPT_WITH_SEARCH` + `VISION_USER_PROMPT_TEMPLATE_WITH_WITH_SEARCH`
  - Model: `VISION_MODEL_ONLINE` (or auto-derived from `VISION_MODEL` with `:online`)
  - Behavior: prompts the model to use web search for comps.
- `dedicated`: price is generated by a separate pricing model.
  - Prompts: `PRICE_SYSTEM_PROMPT` + `PRICE_USER_PROMPT_TEMPLATE`
  - Model: `PRICE_MODEL`
  - Behavior: vision model runs without pricing; pricing model uses the image and queries (per prompt).
  - Failure mode: if pricing fails, `prices` is empty and the source is marked as failed in debug.

## Prompt overview

All prompts live in `app/llm/prompts.py`.

- Vision (no pricing): `VISION_SYSTEM_PROMPT` + `VISION_USER_PROMPT_TEMPLATE`
  - Generates title, description, top-level category, and brand.
- Vision (inline pricing): `VISION_SYSTEM_PROMPT_WITH_PRICE` + `VISION_USER_PROMPT_WITH_PRICE`
  - Same as above plus 3 inline price points from the image.
- Vision (search pricing): `VISION_SYSTEM_PROMPT_WITH_SEARCH` + `VISION_USER_PROMPT_TEMPLATE_WITH_WITH_SEARCH`
  - Same as above plus price points based on instructed web search.
- Title-only category: `PRODUCT_TITLE_CATEGORY_SYSTEM_PROMPT` + `PRODUCT_TITLE_CATEGORY_USER_PROMPT`
  - Classifies a title to a top-level category.
- Category selection: `CATEGORY_SYSTEM_PROMPT` + `CATEGORY_USER_PROMPT_TEMPLATE`
  - Chooses best category path and up to 2 alternatives from the candidate list.
- Dedicated price: `PRICE_SYSTEM_PROMPT` + `PRICE_USER_PROMPT_TEMPLATE`
  - Uses a pricing model to derive prices from Mercari comps (per prompt instructions).

## Environment variables

Booleans accept `1`, `true`, `yes`, or `on`.

- `OPENROUTER_API_KEY` (required): OpenRouter API key.
- `VISION_MODEL` (default: empty): model for image understanding.
- `VISION_MODEL_ONLINE` (default: empty): optional override for online mode; auto derived if empty.
- `PRICE_MODEL` (default: `openai/gpt-4.1:online`): model for price estimation.
- `CATEGORY_MODEL` (default: empty): model for category selection.
- `BRAND_CSV_PATH` (default: `data/brand.csv`): brand data CSV path.
- `CATEGORY_CSV_PATH` (default: `data/category.csv`): category data CSV path.
- `OPENROUTER_BASE_URL` (default: `https://openrouter.ai/api/v1/chat/completions`): API base URL.
- `OPENROUTER_REFERER` (default: empty): optional referer header.
- `OPENROUTER_APP_NAME` (default: `mercari-image-backend`): app name header.
- `REQUEST_TIMEOUT` (default: `60`): OpenRouter request timeout in seconds.
- `ENABLE_DEBUG` (default: `true`): allow debug response fields.
- `MAX_IMAGE_BYTES` (default: `5242880`): max upload size in bytes.
- `LOG_LLM_RAW` (default: `false`): write raw LLM logs under `logs/`.
- `LOG_REQUESTS` (default: `true`): write request logs under `logs/requests/`.
- `LOG_REQUESTS_RETENTION_DAYS` (default: `7`): request log retention days.
- `LOG_REQUESTS_MAX_FILES` (default: `1000`): cap on request log files.
- `CATEGORY_LLM_RETRY_ENABLED` (default: `0`): enable retries for category selection calls.
- `CATEGORY_LLM_MAX_RETRIES` (default: `1`): number of additional attempts when retries are enabled.

Category retries apply only to the category selection step and cover OpenRouter request errors and JSON parsing failures, using exponential backoff (0.2s, 0.4s, 0.8s, capped).
