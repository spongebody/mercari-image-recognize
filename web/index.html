<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mercari å•†å“ç”»åƒè­˜åˆ¥ãƒ†ã‚¹ã‚¿ãƒ¼</title>
    <style>
      :root {
        --bg: #f7f8fa;
        --card: #ffffff;
        --text: #1c1f25;
        --muted: #6b7280;
        --accent: #2f80ed;
        --border: #e5e7eb;
        --danger: #e11d48;
        --success: #16a34a;
        --warning: #f59e0b;
        --shadow: 0 14px 40px rgba(15, 23, 42, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at 10% 20%, #eef2ff 0, transparent 25%),
          radial-gradient(circle at 80% 0%, #e0f2fe 0, transparent 28%),
          var(--bg);
        color: var(--text);
        font-family: "Inter", "Noto Sans JP", system-ui, -apple-system, sans-serif;
        min-height: 100vh;
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 28px 20px 40px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 18px;
      }

      h1 {
        margin: 0;
        font-size: 26px;
        letter-spacing: -0.2px;
      }

      .pill {
        background: #e0e7ff;
        color: #1e3a8a;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.1px;
      }

      .main-layout {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 16px;
      }

      @media (max-width: 1024px) {
        .main-layout {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        box-shadow: var(--shadow);
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      .controls {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 6px;
      }

      /* æ”¹è¿›çš„æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ - æ”¯æŒæ‰¹é‡ */
      .upload-area {
        position: relative;
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 32px 20px;
        text-align: center;
        background: #fdfdfd;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: var(--accent);
        background: #f8faff;
      }

      .upload-area.drag-over {
        border-color: var(--accent);
        background: #eff6ff;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
      }

      .upload-text {
        font-size: 15px;
        color: var(--text);
        font-weight: 600;
        margin-bottom: 6px;
      }

      .upload-hint {
        font-size: 13px;
        color: var(--muted);
      }

      input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* æ‰¹é‡é¢„è§ˆç½‘æ ¼ */
      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        max-height: 300px;
        overflow-y: auto;
        padding: 2px;
      }

      .preview-item {
        position: relative;
        border: 2px solid #e0f2fe;
        border-radius: 10px;
        overflow: hidden;
        background: white;
        transition: all 0.2s ease;
      }

      .preview-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .preview-item.processing {
        border-color: var(--accent);
        animation: borderPulse 1.5s infinite;
      }

      .preview-item.success {
        border-color: var(--success);
      }

      .preview-item.error {
        border-color: var(--danger);
      }

      @keyframes borderPulse {
        0%, 100% { border-color: var(--accent); }
        50% { border-color: #93c5fd; }
      }

      .preview-item img {
        width: 100%;
        height: 140px;
        object-fit: cover;
      }

      .preview-item .info {
        padding: 8px;
        font-size: 11px;
        color: var(--muted);
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .preview-item .status-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .preview-item .remove-btn {
        position: absolute;
        top: 6px;
        left: 6px;
        width: 24px;
        height: 24px;
        padding: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        color: var(--danger);
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* æ”¹è¿›çš„è¾“å…¥æ¡†æ ·å¼ */
      select,
      input[type="text"] {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 10px;
        background: #fdfdfd;
        font-size: 14px;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      select:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
        background: white;
        box-shadow: 0 0 0 3px rgba(47, 128, 237, 0.1);
      }

      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%236b7280' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        padding-right: 40px;
      }

      button {
        width: 100%;
        border: none;
        background: linear-gradient(135deg, var(--accent), #1d4ed8);
        color: white;
        padding: 14px 16px;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.08s ease, box-shadow 0.08s ease;
        box-shadow: 0 10px 25px rgba(47, 128, 237, 0.2);
      }

      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(47, 128, 237, 0.28);
      }

      button.secondary {
        background: white;
        color: var(--text);
        border: 2px solid var(--border);
        box-shadow: none;
      }

      button.secondary:hover {
        background: #f8fafc;
      }

      /* ç»Ÿè®¡é¢æ¿ */
      .stats-panel {
        position: sticky;
        top: 20px;
      }

      .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .stats-header h2 {
        margin: 0;
        font-size: 18px;
      }

      .clear-btn {
        width: auto;
        padding: 6px 12px;
        font-size: 12px;
        background: transparent;
        color: var(--danger);
        border: 1px solid var(--danger);
        box-shadow: none;
      }

      .stat-card {
        padding: 16px;
        border-radius: 10px;
        background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        margin-bottom: 12px;
      }

      .stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text);
      }

      .stat-breakdown {
        display: grid;
        gap: 8px;
        margin-top: 12px;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid;
      }

      .stat-item.accurate {
        border-left-color: var(--success);
      }

      .stat-item.moderate {
        border-left-color: var(--warning);
      }

      .stat-item.inaccurate {
        border-left-color: var(--danger);
      }

      .stat-item-label {
        font-size: 13px;
        font-weight: 600;
      }

      .stat-item-value {
        font-size: 14px;
        font-weight: 700;
      }

      .stat-item-percent {
        font-size: 11px;
        color: var(--muted);
        margin-left: 6px;
      }

      /* è¿›åº¦æ¡ */
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), #1d4ed8);
        transition: width 0.3s ease;
      }

      /* ç»“æœå¡ç‰‡ */
      .results-section {
        margin-top: 16px;
      }

      .result-card {
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        background: white;
        transition: all 0.2s ease;
      }

      .result-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .result-header {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }

      .result-image {
        width: 120px;
        height: 120px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid #e5e7eb;
        flex-shrink: 0;
      }

      .result-meta {
        flex: 1;
      }

      .result-filename {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
      }

      .result-stats {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 12px;
      }

      /* ç»“æ„åŒ–æ•°æ®å±•ç¤º */
      .result-structured {
        background: #f8fafc;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .field-group {
        margin-bottom: 16px;
      }

      .field-group:last-child {
        margin-bottom: 0;
      }

      .field-label {
        font-size: 11px;
        font-weight: 700;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }

      .field-value {
        font-size: 14px;
        color: var(--text);
        line-height: 1.6;
        background: white;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
      }

      .field-value.large {
        font-size: 18px;
        font-weight: 600;
      }

      .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .tag {
        display: inline-block;
        padding: 6px 12px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 13px;
        color: var(--text);
      }

      .tag.primary {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
        font-weight: 600;
      }

      /* å±•å¼€/æ”¶èµ·æŒ‰é’® */
      .toggle-json {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        font-size: 12px;
        color: var(--accent);
        background: transparent;
        border: 1px solid var(--accent);
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 12px;
        width: auto;
        box-shadow: none;
      }

      .toggle-json:hover {
        background: #eff6ff;
      }

      .raw-json {
        display: none;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        background: #0b1220;
        color: #d7e1ff;
        padding: 12px;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 8px;
        line-height: 1.6;
      }

      .raw-json.show {
        display: block;
      }

      /* è¯„ä»·æŒ‰é’®ç»„ */
      .rating-section {
        border-top: 1px solid var(--border);
        padding-top: 16px;
        margin-top: 16px;
      }

      .rating-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 8px;
      }

      .rating-btn {
        width: 100%;
        padding: 10px 12px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 8px;
        border: 2px solid;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .rating-btn.accurate {
        border-color: var(--success);
        color: var(--success);
      }

      .rating-btn.accurate:hover,
      .rating-btn.accurate.active {
        background: var(--success);
        color: white;
      }

      .rating-btn.moderate {
        border-color: var(--warning);
        color: var(--warning);
      }

      .rating-btn.moderate:hover,
      .rating-btn.moderate.active {
        background: var(--warning);
        color: white;
      }

      .rating-btn.inaccurate {
        border-color: var(--danger);
        color: var(--danger);
      }

      .rating-btn.inaccurate:hover,
      .rating-btn.inaccurate.active {
        background: var(--danger);
        color: white;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .status {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--muted);
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--muted);
        transition: all 0.3s ease;
      }

      .dot.live {
        background: var(--accent);
        box-shadow: 0 0 12px rgba(47, 128, 237, 0.6);
        animation: pulse 1.2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(0.95);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.3);
          opacity: 1;
        }
      }

      .controls-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 640px) {
        .controls-row {
          grid-template-columns: 1fr;
        }
        
        .result-header {
          flex-direction: column;
        }
        
        .result-image {
          width: 100%;
          height: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div>
          <h1>Mercari å•†å“å›¾ç‰‡è¯†åˆ«æµ‹è¯•</h1>
          <p class="status">
            <span class="dot" id="status-dot"></span>
            <span id="status-text">å¾…å‘½</span>
          </p>
        </div>
        <span class="pill">æ‰¹é‡æµ‹è¯•ç‰ˆ</span>
      </header>

      <div class="main-layout">
        <!-- å·¦ä¾§ä¸»è¦å†…å®¹ -->
        <div class="grid">
          <div class="card grid">
            <!-- æ‰¹é‡æ–‡ä»¶ä¸Šä¼  -->
            <div>
              <label>å•†å“å›¾ç‰‡ï¼ˆæ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼‰</label>
              <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“¸</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒå¤šé€‰ï¼ŒJPGã€PNGã€GIF ç­‰æ ¼å¼</div>
                <input type="file" id="image" accept="image/*" multiple />
              </div>
            </div>

            <!-- æ‰¹é‡é¢„è§ˆ -->
            <div id="preview-container" style="display: none">
              <label>å·²é€‰æ‹© <span id="file-count">0</span> å¼ å›¾ç‰‡</label>
              <div class="preview-grid" id="preview-grid"></div>
            </div>

            <!-- é…ç½®é€‰é¡¹ -->
            <div class="controls-row">
              <div>
                <label for="language">æ ‡é¢˜/æè¿°è¯­è¨€</label>
                <select id="language">
                  <option value="ja" selected>æ—¥è¯­</option>
                  <option value="en">è‹±è¯­</option>
                  <option value="zh">ç®€ä½“ä¸­æ–‡</option>
                </select>
              </div>
              <div>
                <label for="api-endpoint">æ¥å£åœ°å€</label>
                <input
                  type="text"
                  id="api-endpoint"
                  value=""
                  placeholder="è¯·è¾“å…¥APIåœ°å€"
                />
              </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <button id="submit-btn">
                <span id="button-text">å¼€å§‹è¯†åˆ«</span>
              </button>
              <button class="secondary" id="clear-files-btn">æ¸…ç©ºå›¾ç‰‡</button>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div id="progress-section" style="display: none;">
              <label>å¤„ç†è¿›åº¦</label>
              <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px;">
                <span id="progress-text">0 / 0</span>
                <span id="progress-percent">0%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
              </div>
            </div>
          </div>

          <!-- ç»“æœåˆ—è¡¨ -->
          <div class="results-section">
            <h2 style="margin: 0 0 12px 0; font-size: 18px;">è¯†åˆ«ç»“æœ</h2>
            <div id="results-list"></div>
          </div>
        </div>

        <!-- å³ä¾§ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
          <div class="card">
            <div class="stats-header">
              <h2>æµ‹è¯•ç»Ÿè®¡</h2>
              <button class="clear-btn" id="clear-stats-btn">æ¸…ç©º</button>
            </div>

            <div class="stat-card">
              <div class="stat-label">æ€»æµ‹è¯•æ¬¡æ•°</div>
              <div class="stat-value" id="total-count">0</div>
            </div>

            <div class="stat-breakdown">
              <div class="stat-item accurate">
                <span class="stat-item-label">âœ… å‡†ç¡®</span>
                <div>
                  <span class="stat-item-value" id="accurate-count">0</span>
                  <span class="stat-item-percent" id="accurate-percent">0%</span>
                </div>
              </div>
              <div class="stat-item moderate">
                <span class="stat-item-label">âš ï¸ ä¸€èˆ¬</span>
                <div>
                  <span class="stat-item-value" id="moderate-count">0</span>
                  <span class="stat-item-percent" id="moderate-percent">0%</span>
                </div>
              </div>
              <div class="stat-item inaccurate">
                <span class="stat-item-label">âŒ é”™è¯¯</span>
                <div>
                  <span class="stat-item-value" id="inaccurate-count">0</span>
                  <span class="stat-item-percent" id="inaccurate-percent">0%</span>
                </div>
              </div>
            </div>

            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
              <div class="stat-label">å‡†ç¡®ç‡</div>
              <div class="stat-value" style="font-size: 24px; color: var(--success);" id="accuracy-rate">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€çŠ¶æ€
      let selectedFiles = [];
      let testResults = [];
      let processing = false;
      let resultRatings = {}; // è·Ÿè¸ªæ¯ä¸ªç»“æœçš„è¯„ä»·çŠ¶æ€ { resultId: 'accurate' | 'moderate' | 'inaccurate' | null }

      // DOM å…ƒç´ 
      const imageInput = document.getElementById("image");
      const uploadArea = document.getElementById("upload-area");
      const previewContainer = document.getElementById("preview-container");
      const previewGrid = document.getElementById("preview-grid");
      const fileCount = document.getElementById("file-count");
      const languageSelect = document.getElementById("language");
      const apiInput = document.getElementById("api-endpoint");
      const submitBtn = document.getElementById("submit-btn");
      const buttonText = document.getElementById("button-text");
      const clearFilesBtn = document.getElementById("clear-files-btn");
      const progressSection = document.getElementById("progress-section");
      const progressText = document.getElementById("progress-text");
      const progressPercent = document.getElementById("progress-percent");
      const progressFill = document.getElementById("progress-fill");
      const resultsList = document.getElementById("results-list");
      const statusText = document.getElementById("status-text");
      const statusDot = document.getElementById("status-dot");
      const clearStatsBtn = document.getElementById("clear-stats-btn");

      // ç»Ÿè®¡å…ƒç´ 
      const totalCountEl = document.getElementById("total-count");
      const accurateCountEl = document.getElementById("accurate-count");
      const accuratePercentEl = document.getElementById("accurate-percent");
      const moderateCountEl = document.getElementById("moderate-count");
      const moderatePercentEl = document.getElementById("moderate-percent");
      const inaccurateCountEl = document.getElementById("inaccurate-count");
      const inaccuratePercentEl = document.getElementById("inaccurate-percent");
      const accuracyRateEl = document.getElementById("accuracy-rate");

      // LocalStorage ç®¡ç†
      const STORAGE_KEY = "mercari_test_stats";

      function loadStats() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : { accurate: 0, moderate: 0, inaccurate: 0, history: [] };
      }

      function saveStats(stats) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
        updateStatsDisplay();
      }

      function updateStatsDisplay() {
        const stats = loadStats();
        const total = stats.accurate + stats.moderate + stats.inaccurate;
        
        totalCountEl.textContent = total;
        accurateCountEl.textContent = stats.accurate;
        moderateCountEl.textContent = stats.moderate;
        inaccurateCountEl.textContent = stats.inaccurate;
        
        if (total > 0) {
          const accuratePercent = ((stats.accurate / total) * 100).toFixed(1);
          const moderatePercent = ((stats.moderate / total) * 100).toFixed(1);
          const inaccuratePercent = ((stats.inaccurate / total) * 100).toFixed(1);
          
          accuratePercentEl.textContent = `${accuratePercent}%`;
          moderatePercentEl.textContent = `${moderatePercent}%`;
          inaccuratePercentEl.textContent = `${inaccuratePercent}%`;
          accuracyRateEl.textContent = `${accuratePercent}%`;
        } else {
          accuratePercentEl.textContent = "0%";
          moderatePercentEl.textContent = "0%";
          inaccuratePercentEl.textContent = "0%";
          accuracyRateEl.textContent = "--";
        }
      }

      function recordRating(resultId, newRating) {
        const stats = loadStats();
        const oldRating = resultRatings[resultId];
        
        // å¦‚æœä¹‹å‰æœ‰è¯„ä»·ï¼Œå…ˆå‡å»
        if (oldRating) {
          stats[oldRating]--;
        }
        
        // æ·»åŠ æ–°è¯„ä»·
        stats[newRating]++;
        resultRatings[resultId] = newRating;
        
        // ä¿å­˜å†å²è®°å½•
        stats.history.push({ 
          resultId,
          rating: newRating, 
          oldRating: oldRating || null,
          timestamp: Date.now() 
        });
        
        saveStats(stats);
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatBytes(bytes) {
        const units = ["B", "KB", "MB"];
        let size = bytes;
        let i = 0;
        while (size >= 1024 && i < units.length - 1) {
          size /= 1024;
          i++;
        }
        return `${size.toFixed(size >= 10 ? 0 : 1)} ${units[i]}`;
      }

      // æ ¼å¼åŒ–ç»“æœæ•°æ®ï¼ˆç»“æ„åŒ–å±•ç¤ºï¼‰
      function formatResultData(payload) {
        if (payload.error) {
          return `<div class="field-value" style="color: var(--danger);">âŒ ${payload.error}</div>`;
        }

        const data = payload.data || payload;
        let html = '';

        // æ ‡é¢˜
        if (data.title) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸ“ æ ‡é¢˜</div>
              <div class="field-value large">${escapeHtml(data.title)}</div>
            </div>
          `;
        }

        // æè¿°
        if (data.description) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸ“„ æè¿°</div>
              <div class="field-value">${escapeHtml(data.description)}</div>
            </div>
          `;
        }

        // åˆ†ç±»ï¼ˆå•ä¸ªï¼‰
        if (data.category_id || data.category_name) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸ·ï¸ åˆ†ç±»</div>
              <div class="tags-container">
                ${data.category_name ? `<span class="tag primary">${escapeHtml(data.category_name)}</span>` : ''}
                ${data.category_id ? `<span class="tag">ID: ${escapeHtml(String(data.category_id))}</span>` : ''}
              </div>
            </div>
          `;
        }

        // åˆ†ç±»åˆ—è¡¨ï¼ˆå¤šä¸ªå€™é€‰ï¼‰
        if (data.categories && Array.isArray(data.categories) && data.categories.length > 0) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸ·ï¸ åˆ†ç±»å€™é€‰ (${data.categories.length})</div>
              <div class="tags-container">
                ${data.categories.map((cat, index) => {
                  const name = cat.name || cat.category_name || 'æœªçŸ¥åˆ†ç±»';
                  const id = cat.id || cat.category_id || '';
                  const confidence = cat.confidence || cat.score;
                  const isPrimary = index === 0 ? 'primary' : '';
                  
                  let label = escapeHtml(name);
                  if (id) label += ` (ID: ${escapeHtml(String(id))})`;
                  if (confidence !== undefined) {
                    const confidencePercent = (confidence * 100).toFixed(1);
                    label += ` - ${confidencePercent}%`;
                  }
                  
                  return `<span class="tag ${isPrimary}">${label}</span>`;
                }).join('')}
              </div>
            </div>
          `;
        }

        // å“ç‰Œ
        if (data.brand_id || data.brand_name) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸ”– å“ç‰Œ</div>
              <div class="tags-container">
                ${data.brand_name ? `<span class="tag primary">${escapeHtml(data.brand_name)}</span>` : ''}
                ${data.brand_id ? `<span class="tag">ID: ${escapeHtml(String(data.brand_id))}</span>` : ''}
              </div>
            </div>
          `;
        }

        // ä»·æ ¼ï¼ˆå•ä¸ªï¼‰
        if (data.price !== undefined && data.price !== null) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸ’° å»ºè®®ä»·æ ¼</div>
              <div class="field-value">Â¥${escapeHtml(String(data.price))}</div>
            </div>
          `;
        }

        // ä»·æ ¼åˆ—è¡¨ï¼ˆå¤šä¸ªå€™é€‰æˆ–ä»·æ ¼èŒƒå›´ï¼‰
        if (data.prices) {
          html += `<div class="field-group"><div class="field-label">ğŸ’° ä»·æ ¼å»ºè®®</div>`;
          
          // å¦‚æœæ˜¯æ•°ç»„
          if (Array.isArray(data.prices)) {
            html += `<div class="tags-container">`;
            data.prices.forEach((priceItem, index) => {
              const isPrimary = index === 0 ? 'primary' : '';
              if (typeof priceItem === 'number') {
                html += `<span class="tag ${isPrimary}">Â¥${escapeHtml(String(priceItem))}</span>`;
              } else if (typeof priceItem === 'object') {
                const price = priceItem.price || priceItem.value;
                const confidence = priceItem.confidence || priceItem.score;
                let label = `Â¥${escapeHtml(String(price))}`;
                if (confidence !== undefined) {
                  label += ` (${(confidence * 100).toFixed(1)}%)`;
                }
                html += `<span class="tag ${isPrimary}">${label}</span>`;
              }
            });
            html += `</div>`;
          } 
          // å¦‚æœæ˜¯å¯¹è±¡ï¼ˆä»·æ ¼èŒƒå›´ï¼‰
          else if (typeof data.prices === 'object') {
            const minPrice = data.prices.min || data.prices.minimum;
            const maxPrice = data.prices.max || data.prices.maximum;
            const avgPrice = data.prices.avg || data.prices.average || data.prices.suggested;
            
            html += `<div class="tags-container">`;
            if (minPrice !== undefined) {
              html += `<span class="tag">æœ€ä½: Â¥${escapeHtml(String(minPrice))}</span>`;
            }
            if (avgPrice !== undefined) {
              html += `<span class="tag primary">å»ºè®®: Â¥${escapeHtml(String(avgPrice))}</span>`;
            }
            if (maxPrice !== undefined) {
              html += `<span class="tag">æœ€é«˜: Â¥${escapeHtml(String(maxPrice))}</span>`;
            }
            html += `</div>`;
          }
          
          html += `</div>`;
        }

        // å•†å“çŠ¶æ€
        if (data.item_condition_id || data.item_condition) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸ“¦ å•†å“çŠ¶æ€</div>
              <div class="tags-container">
                ${data.item_condition ? `<span class="tag">${escapeHtml(String(data.item_condition))}</span>` : ''}
                ${data.item_condition_id ? `<span class="tag">ID: ${escapeHtml(String(data.item_condition_id))}</span>` : ''}
              </div>
            </div>
          `;
        }

        // é…é€æ–¹å¼
        if (data.shipping_method) {
          html += `
            <div class="field-group">
              <div class="field-label">ğŸšš é…é€æ–¹å¼</div>
              <div class="field-value">${escapeHtml(String(data.shipping_method))}</div>
            </div>
          `;
        }

        return html || '<div class="field-value">æ— ç»“æ„åŒ–æ•°æ®</div>';
      }
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
      function updateFileList() {
        previewGrid.innerHTML = "";
        fileCount.textContent = selectedFiles.length;
        
        if (selectedFiles.length === 0) {
          previewContainer.style.display = "none";
          return;
        }
        
        previewContainer.style.display = "block";
        
        selectedFiles.forEach((fileObj, index) => {
          const item = document.createElement("div");
          item.className = "preview-item";
          item.dataset.index = index;
          
          const img = document.createElement("img");
          img.src = fileObj.url;
          
          const info = document.createElement("div");
          info.className = "info";
          info.textContent = `${fileObj.file.name} (${formatBytes(fileObj.file.size)})`;
          
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn";
          removeBtn.innerHTML = "Ã—";
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            selectedFiles.splice(index, 1);
            updateFileList();
          };
          
          item.appendChild(img);
          item.appendChild(info);
          item.appendChild(removeBtn);
          previewGrid.appendChild(item);
        });
      }

      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      function handleFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type.startsWith("image/"));
        
        newFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            selectedFiles.push({
              file: file,
              url: e.target.result,
              status: "pending"
            });
            updateFileList();
          };
          reader.readAsDataURL(file);
        });
      }

      // äº‹ä»¶ç›‘å¬
      imageInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
      });

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("drag-over");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("drag-over");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("drag-over");
        handleFiles(e.dataTransfer.files);
      });

      clearFilesBtn.addEventListener("click", () => {
        selectedFiles = [];
        imageInput.value = "";
        updateFileList();
      });

      // æ‰¹é‡å¤„ç†
      async function processFiles() {
        if (selectedFiles.length === 0) {
          alert("è¯·å…ˆé€‰æ‹©å›¾ç‰‡");
          return;
        }
        
        const endpoint = apiInput.value.trim() || '/api/v1/mercari/image/analyze';
        if (!endpoint) {
          alert("è¯·å¡«å†™æ¥å£åœ°å€");
          return;
        }
        
        processing = true;
        submitBtn.disabled = true;
        buttonText.innerHTML = '<span class="spinner"></span> å¤„ç†ä¸­...';
        statusText.textContent = "æ‰¹é‡å¤„ç†ä¸­...";
        statusDot.classList.add("live");
        progressSection.style.display = "block";
        resultsList.innerHTML = "";
        
        let completed = 0;
        const total = selectedFiles.length;
        
        for (let i = 0; i < selectedFiles.length; i++) {
          const fileObj = selectedFiles[i];
          const previewItem = previewGrid.children[i];
          
          // æ›´æ–°çŠ¶æ€
          previewItem.classList.add("processing");
          const statusBadge = document.createElement("div");
          statusBadge.className = "status-badge";
          statusBadge.textContent = "å¤„ç†ä¸­...";
          previewItem.appendChild(statusBadge);
          
          try {
            const formData = new FormData();
            formData.append("image", fileObj.file);
            formData.append("language", languageSelect.value);
            
            const start = performance.now();
            const resp = await fetch(endpoint, {
              method: "POST",
              body: formData,
            });
            
            const elapsedMs = performance.now() - start;
            const text = await resp.text();
            let payload = {};
            
            try {
              payload = JSON.parse(text);
            } catch (err) {
              payload = { error: "JSON parse failed", raw: text };
            }
            
            // æ›´æ–°é¢„è§ˆçŠ¶æ€
            previewItem.classList.remove("processing");
            if (resp.ok) {
              previewItem.classList.add("success");
              statusBadge.textContent = "âœ“ å®Œæˆ";
              statusBadge.style.background = "#dcfce7";
              statusBadge.style.color = "#15803d";
              
              // æ·»åŠ ç»“æœå¡ç‰‡
              addResultCard(fileObj, payload, elapsedMs, true);
            } else {
              previewItem.classList.add("error");
              statusBadge.textContent = "âœ— å¤±è´¥";
              statusBadge.style.background = "#fee2e2";
              statusBadge.style.color = "#991b1b";
              
              addResultCard(fileObj, payload, elapsedMs, false);
            }
          } catch (err) {
            previewItem.classList.remove("processing");
            previewItem.classList.add("error");
            statusBadge.textContent = "âœ— é”™è¯¯";
            statusBadge.style.background = "#fee2e2";
            statusBadge.style.color = "#991b1b";
            
            addResultCard(fileObj, { error: String(err) }, 0, false);
          }
          
          completed++;
          progressText.textContent = `${completed} / ${total}`;
          const percent = (completed / total) * 100;
          progressPercent.textContent = `${percent.toFixed(0)}%`;
          progressFill.style.width = `${percent}%`;
        }
        
        processing = false;
        submitBtn.disabled = false;
        buttonText.textContent = "å¼€å§‹è¯†åˆ«";
        statusText.textContent = "å®Œæˆ";
        statusDot.classList.remove("live");
      }

      // æ·»åŠ ç»“æœå¡ç‰‡
      function addResultCard(fileObj, payload, elapsedMs, success) {
        const card = document.createElement("div");
        card.className = "result-card";
        
        const resultId = 'result_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        card.dataset.resultId = resultId;
        
        const structuredData = formatResultData(payload);
        const rawJson = JSON.stringify(payload, null, 2);
        
        card.innerHTML = `
          <div class="result-header">
            <img src="${fileObj.url}" class="result-image" alt="result">
            <div class="result-meta">
              <div class="result-filename">${escapeHtml(fileObj.file.name)}</div>
              <div class="result-stats">
                <span>â±ï¸ ${(elapsedMs / 1000).toFixed(2)}s</span>
                <span>${success ? '<span style="color: var(--success)">âœ“ æˆåŠŸ</span>' : '<span style="color: var(--danger)">âœ— å¤±è´¥</span>'}</span>
                <span>ğŸ“¦ ${formatBytes(fileObj.file.size)}</span>
              </div>
            </div>
          </div>
          
          <div class="result-structured">
            ${structuredData}
          </div>
          
          <button class="toggle-json" onclick="toggleJson('${resultId}')">
            <span>ğŸ“‹</span>
            <span class="toggle-text">æŸ¥çœ‹åŸå§‹ JSON</span>
          </button>
          
          <pre class="raw-json" id="json-${resultId}">${escapeHtml(rawJson)}</pre>
          
          ${success ? `
            <div class="rating-section">
              <label>è¯„ä»·è¯†åˆ«ç»“æœï¼š</label>
              <div class="rating-buttons">
                <button class="rating-btn accurate" onclick="rateResult('${resultId}', 'accurate', this)">âœ… å‡†ç¡®</button>
                <button class="rating-btn moderate" onclick="rateResult('${resultId}', 'moderate', this)">âš ï¸ ä¸€èˆ¬</button>
                <button class="rating-btn inaccurate" onclick="rateResult('${resultId}', 'inaccurate', this)">âŒ é”™è¯¯</button>
              </div>
            </div>
          ` : ''}
        `;
        
        resultsList.insertBefore(card, resultsList.firstChild);
      }

      // åˆ‡æ¢ JSON æ˜¾ç¤º
      window.toggleJson = function(resultId) {
        const jsonEl = document.getElementById(`json-${resultId}`);
        const toggleBtn = event.target.closest('.toggle-json');
        const toggleText = toggleBtn.querySelector('.toggle-text');
        
        if (jsonEl.classList.contains('show')) {
          jsonEl.classList.remove('show');
          toggleText.textContent = 'æŸ¥çœ‹åŸå§‹ JSON';
        } else {
          jsonEl.classList.add('show');
          toggleText.textContent = 'éšè—åŸå§‹ JSON';
        }
      };

      // è¯„ä»·ç»“æœï¼ˆä¿®å¤é‡å¤è®¡æ•°é—®é¢˜ï¼‰
      window.rateResult = function(resultId, rating, btn) {
        const buttons = btn.parentElement.querySelectorAll(".rating-btn");
        
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ active çŠ¶æ€
        buttons.forEach(b => b.classList.remove("active"));
        
        // æ¿€æ´»å½“å‰æŒ‰é’®
        btn.classList.add("active");
        
        // è®°å½•è¯„ä»·ï¼ˆä¼šè‡ªåŠ¨å¤„ç†æ—§è¯„ä»·çš„å‡æ³•ï¼‰
        recordRating(resultId, rating);
      };

      // æ¸…ç©ºç»Ÿè®¡
      clearStatsBtn.addEventListener("click", () => {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµ‹è¯•ç»Ÿè®¡æ•°æ®å—ï¼Ÿ")) {
          localStorage.removeItem(STORAGE_KEY);
          resultRatings = {};
          updateStatsDisplay();
        }
      });

      // æäº¤å¤„ç†
      submitBtn.addEventListener("click", processFiles);

      // åˆå§‹åŒ–
      updateStatsDisplay();
    </script>
  </body>
</html>
