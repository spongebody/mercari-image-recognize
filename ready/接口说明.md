# Mercari 商品图片识别 API

## 概述

本接口基于多模态大语言模型（当前使用 google/gemini-2.5-flash），可自动分析 Mercari 商品图片并生成标题、描述、价格建议、分类和品牌信息。

**服务地址：** `http://43.133.171.134:39008`

---

## API 端点

### 图片分析接口

**请求信息**

- **方法：** `POST`
- **路径：** `/api/v1/mercari/image/analyze`
- **Content-Type：** `multipart/form-data`

**文件限制**

- 最大文件大小：5MB（可调整）
- 支持格式：`image/jpeg`、`image/png`、`image/webp`

---

## 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `image` | file | ✓ | 商品图片文件（单张） |
| `language` | string | ✗ | 输出语言，可选值：`ja`（日语）、`en`（英语）、`zh`（中文），默认：`ja` |
| `debug` | boolean/string | ✗ | 是否返回调试信息，可选值：`true`/`false`，默认：`false` |

---

## 响应说明

### 成功响应（200 OK）

**Content-Type：** `application/json`

**响应示例**
```
{
  "title": "Nintendo Switch Lite ターコイズ 本体",
  "description": "状態は良好で、付属品は本体のみです。動作確認済みです。",
  "prices": [8500, 9000, 9500],
  "categories": [
    { "id": "003", "name": "CD・DVD・ブルーレイ > CD > アニメ" },
    { "id": "002", "name": "CD・DVD・ブルーレイ > CD > その他" },
    { "id": "001", "name": "CD・DVD・ブルーレイ > CD > K-POP・アジア" }
  ],
  "brand_name": "Nintendo"
}
```
**字段说明**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `title` | string | 商品标题 |
| `description` | string | 商品描述 |
| `prices` | array[integer] | 价格建议（日元），包含 3 个已排序的价格值。若原始数据不足 3 个，将重复最后一个值补足 |
| `categories` | array[object] | 推荐分类列表，包含 0-3 个元素 |
| `categories[].id` | string | 分类 ID（category_id） |
| `categories[].name` | string | 分类完整路径（多级分类用 `>` 分隔） |
| `brand_name` | string | 品牌名称。若未在品牌库中找到匹配项，则返回空字符串 |

**调试模式（debug=true）**

当 `debug` 参数设置为 `true` 时，响应中会额外包含 `_debug` 对象：

| 字段名 | 说明 |
|--------|------|
| `_debug.ai_raw` | 视觉 LLM 原始 JSON 输出 |
| `_debug.group_name` | 识别的一级分类名称 |
| `_debug.llm_category_raw` | 二次分类 LLM 原始 JSON 输出 |

---

## 调用示例

```
curl -X POST http://43.133.171.134:39008/api/v1/mercari/image/analyze \
  -F "image=@/path/to/item.jpg" \
  -F "language=ja" \
  -F "debug=false"
```

## 注意事项

1. **支持格式：** 仅支持 JPEG、PNG 和 WebP 格式
2. **单次请求：** 每次请求仅支持单张图片
3. **价格单位：** 所有价格均为日元（JPY）
4. **分类匹配：** 系统会返回 0-3 个最相关的分类建议
5. **品牌识别：** 品牌识别基于预定义品牌库，未收录的品牌将返回空字符串

---

## 商品标题分类接口（含图片兜底）

### 请求信息

- **方法：** `POST`
- **路径：** `/api/v1/mercari/title/analyze`
- **Content-Type：** `application/json`

### 请求体

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `title` | string | ✓ | 商品标题 |
| `image_url` | string | ✗ | 商品图片 URL（当标题无法得出有效分类时用于兜底识别） |
| `language` | string | ✗ | 标题语言，可选 `ja` / `en` / `zh`，默认 `ja` |

### 处理流程
1. 基于标题调用分类模型，返回 `top_level_category`，并在该一级类目下选择最匹配的类目路径。
2. 如果标题分类失败或未找到有效路径，则使用 `image_url` 走图片识别流程做兜底。
3. 最终始终返回 `best_target_path`，并附带可用的 `alternatives`。

### 成功响应示例
```
{
  "best_target_path": "ファッション > メンズ > 小物 > 折り財布 > 二つ折り財布",
  "alternatives": [
    "ファッション > メンズ > 小物 > 折り財布 > その他",
    "ファッション > メンズ > 小物 > その他"
  ]
}
```

### 错误响应
- 400：缺少必填 `title`、语言非法，或兜底所需的 `image_url` 无效/缺失。
- 502：LLM 请求失败。

### 调用示例
```
curl -X POST http://43.133.171.134:39008/api/v1/mercari/title/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "title": "CB400SF VTEC REVO 専用 ハイスロKIT・ブラックアウターSET",
    "language": "ja",
    "image_url": "https://example.com/item.jpg"
  }'
```
